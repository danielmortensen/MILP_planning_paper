\section{Battery State of Charge}
Battery state of charge (SOC) plays a role in the bus charge problem. Battery charge levels decrease as a bus traverses a route. Solutions to the bus charge problem account for routes and require that SOC values remain above a minimum threshold. 
\par A SOC thresholding constraint requires that battery charge levels be estimated. The $k^{\text{th}}$ SOC for bus $i$ is denoted $d_{i,k}$, where $k$ is the \textit{node index}. Node indices are time agnostic such that $d_{i,k+1}$ represents the SOC bus node following $d_{i,k}$ as seen in figure \ref{fig:dSocDiagram}. 
\par Because no charging is performed while on route, $d_{i,k}$ will be lowest as buses enter the charge station. Let $d_{i,k+1}$ be the charge level for bus $i$ as it enters the charge station, and $\delta_i$ represent the power discharged while on-route. The entrance SOC can be expressed as 
\begin{align}
	d_{i,k+1} = d_{i,k} - \delta_i,
\end{align}
where $d_{i,k}$ is the previous departure SOC for bus $i$. Consider the example in figure \ref{fig:graphDelta}, where buses $1$ and $2$ leave the station at $t_2$ and enter at $t_4$. The corresponding change in SOC is given as $d_{1,2} = d_{1,1} - \delta_1$ and $d_{2,2} = d_{2,1} - \delta_2$ for buses $1$ and $2$ respectively.
\input{media/graphDelta}
\par Time periods between entrance and exit nodes represent time spent in the charge station and have the potential to charge the battery. An edge over which charging occures is refered to as $x_{i,k}$, where $k$ gives the index of the edge's outgoing node, and $i$ refers to the bus.  When a charger occupies $x_{i,k}$, the resulting increase, or \textit{gain}, in battery charge is denoted $g_{i,k}$, where $i$ and $k$ mirror the edge indices (see figure \ref{fig:dSocDiagram}). 
\par The value for $g_{i,k}$ is computed using a single charge rate. Additional flexibility can be encoded be connecting bus nodes with multiple edges, denoted $x_{i,k,l}$. Each edge has a distinct charge rate and gain denoted $g_{i,k,l}$ and together, the set of edges allows for multi-rate charging (see figure \ref{fig:multirateChargeEdges}). Having multiple charge rates gives the option for fast charging when necessary, and slow charging when possible to preserve battery health and decrease the electrical load \cite{houbbadi_optimal_2019}.
\input{media/dSocDiagram.tex}
\input{media/multirateChargeEdges.tex}
\par The rate is selected by setting $x_{i,k,l} = 1$. All gains associated with unselected rates are equal to zero. Gains that correspond to selected rates are computed using the Constant Current Constant Voltage (CCCV) model as derived in \cite{whitaker_network_2021} which gives:
\begin{align}\label{eqn:CCCV}
	d_{i,k+1} = \bar{a}_ld_{i,k} - \bar{b}_lM, 
\end{align}
where $\bar{a}_l$ $\sim(0,1]$, depends on the charge rate and is experimentally determined, $M$ is the battery charge capacity in kWh, and $\bar{b}_l = \bar{a}_l - 1$.
Equation \ref{eqn:CCCV} is used to show that
\begin{equation}\label{eqn:g}
\begin{aligned}
	d_{i,k+1} &= \bar{a}_ld_{i,k} - \bar{b}_lM \\ 
	d_{i,k+1} - d_{i,k} &= \bar{a}_ld_{i,k} - \bar{b}_lM - d_{i,k},\\
\end{aligned}
\end{equation}
but the gain is equal to the difference in $d_{i,k+1}$ and $d_{i,k}$ such that $g_{i,k,l} = d_{i,k+1} - d_{i,k}$.  So
\begin{equation}\label{eqn:CCCVFinal}
\begin{aligned}
	g_{i,k,l}  &= \bar{a}_ld_{i,k} - \bar{b}_lM - d_{i,k}\\
	g_{i,k,l}  &= (\bar{a}_l - 1)d_{i,k} - \bar{b_l}M.\\
\end{aligned}
\end{equation}

Therefore, 
\begin{equation}\label{eqn:initialGConstr}
	\begin{aligned}
		\begin{dcases}
			g_{i,k,l} = d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM & x_{i,k,l} = 1\\
			g_{i,k,l} = 0 & x_{i,k,l} = 0
		\end{dcases}.
	\end{aligned}
\end{equation}
The conditions given in equation \ref{eqn:initialGConstr} can be rewritten as 
\begin{equation}\label{eqn:bigM2}
\begin{aligned}
	& \begin{dcases} 
		\begin{array}{l}
		g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		\end{array}
		& x_{i,k,l} = 1 \\
		\begin{array}{l}
		g_{i,k,l} \le 0 \\
		g_{i,k,l} \ge 0 \\
		\end{array} & x_{i,k,l} = 0\\ 
	\end{dcases} \\ 
	\Rightarrow &  
	\begin{array}{l} 
		 g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}M - M(1 - x_{i,k,l})\\
		 g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}M\\
		 g_{i,k,l} \le 0 + Mx_{i,k,l} \\
		 g_{i,k,l} \ge 0, \\
	\end{array}\\ 
\end{aligned}
\end{equation}
where $M$ is the battery capacity. The results of equation \ref{eqn:bigM2} obtain a switching effect.  When $x_{i,k,l} = 1$, equation \ref{eqn:bigM2} becomes 
\begin{equation}
	\begin{aligned}
		& \begin{rcases}
			g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM & \\
			g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM & \\
		\end{rcases} \text{Active}\\ 
		& \begin{drcases}
			g_{i,k,l} \le M & \\
			g_{i,k,l} \ge 0 & \\ 
		\end{drcases} \text{Inactive} \\
	\end{aligned}
\end{equation}
The active constraints imply equality for $g_{i,k,l}$ = $(\bar{a}_l - 1)d_{i,k} - \bar{b_l}M$.  The inactive constraints imply that $g_{i,k,l}$ is greater then zero and less then the battery capacity, which are trivially satisfied. When $x_{i,k,l} = 0$, equation \ref{eqn:bigM2} becomes
\begin{equation}
	\begin{aligned}
		& \begin{rcases}
			g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM - M &\\
			g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM &\\
		\end{rcases} \text{Inactive} \\
		& \begin{rcases}
			g_{i,k,l}\le 0 & \\
			g_{i,k,l}\ge 0 & \\ 
		\end{rcases}\text{Active}\\
	\end{aligned}
\end{equation}
Where the inactive constraints are again trivially satisfied, and the active imply equality for $g_{i,k,l} = 0$.

\par Equation \ref{eqn:bigM2} can be expressed in standard form as 
\begin{equation}\label{eqn:chargeConstraints}
	\begin{aligned} 
		-g_{i,k,l} + d_{i,k}(\bar{a}_l - 1) + x_{i,k,l} &\le M(\bar{b_l} + 1) \\
		 g_{i,k,l} - d_{i,k}(\bar{a}_l - 1)  &\le  - \bar{b_l}M \\
		 g_{i,k,l} - Mx_{i,k} &\le 0 \\
		-g_{i,k,l} &\le 0.  
	\end{aligned}
\end{equation} 
Because the rate is not known ahead of time, and only one non-zero $g$ value is present, $d_{i,k}$ can be expressed as 
\begin{equation}\label{eqn:totalG}
	d_{i,k + 1} = d_{i,k} + \sum_l g_{i,k,l} 
\end{equation}
In summary, the minimum SOC for all feasible charge plans must exceed a given threshold.  SOC values are computed while the bus is in the charge station.  SOC values are updated when a bus enters by subtracting the discharged energy from the previous SOC estimate. SOC values are updated for in-station periods by adding the charge gains as given in equation \ref{eqn:totalG}.  Gains are computed using a switching constraint which sets them to zero when not charging, otherwise they follow the CCCV model as derived in equation \ref{eqn:CCCVFinal}. Initial SOC values are handled with an equality constraint
\begin{equation}\label{eqn:initialSOC}
	d_{i,0} = \text{initialValue}.
\end{equation}

