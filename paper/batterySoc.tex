\section{Battery State of Charge}
Battery state of charge (SOC) also plays a large role in the bus charge problem. As a bus traverses a route, energy is discharged from the battery. If the battery state of charge drops to zero, the bus will power down and become unresponsive. It is therefore important to track battery charge levels when scheduling charge times.
\par Furthermore, as no charge actions are available while on route, SOC values are only tracked when in the charge station. Because these in-station time periods are also represented by the charge nodes from figure \ref{fig:busAvailEncode}, the two are in one-one correspondence. Consequently, every charge node$_{i,k}$ can be associated with an SOC value, denoted $d_{i,k}$ as shown in figure \ref{fig:socDiagram}.  
\input{media/socDiagram.tex}
\par Charge level progression between $d_{i,k}$ and $d_{i,k+1}$ is influenced by two factors: discharging on route, and charging. The route discharge, denoted $\delta$, represents the energy drawn from the battery in kWh.  When a bus returns from a route, the change in SOC is computed as 
\begin{align}
	d_{i,k+1} = d_{i,k} - \delta_i
\end{align}
where $\delta_i$ is the discharge for Bus $i$'s route as seen in figure \ref{fig:graphDelta}.  
\input{media/graphDelta.tex}
\par When a charger connects to a bus, the increase or \textit{gain} in $d_{i,k}$ is denoted $g_{i,k}$, where $i$ and $k$ represent the respective bus and outgoing node indices. Figure \ref{fig:dSocDiagram} gives an example where $g_{1,1}$ and $g_{1,3}$ correspond to Bus 1's gain from $t_0$ to $t_1$ and $t_4$ to $t_5$.  
\input{media/dSocDiagram.tex}
Using a single charge rate however has drawbacks. If the rate is high, buses will charge quickly but the load on the grid will increase.  Decreased charge rates will stress the grid less but increase charge time. To address both situations, a method with additional flexibility must be used where both high and low charge rates are available. 
\par Let $g_{i,k,l}$ be the gain, where $i$ and $k$ represent the bus and outgoing node indicies as before and $l$ represents the charge rate index. Each charge rate index corresponds to an edge in the graph. Figure \ref{fig:multirateChargeEdges} gives an example where there are three rate options. Each rate corresponds to an edge between two charge nodes and together, all three edges provide multiple options for charging.
\input{media/multirateChargeEdges.tex}
These gains are used to compute succeeding charge levels as 
\begin{align}\label{eqn:gainTotal}
	d_{i,k+1} = d_{i,k} +\sum_{l} g_{i,k,l},
\end{align} 
but because of group and flow constraints, only one charge rate can be active at a time. Therefore, $d_{i,k}$ can be expressed as 
\begin{align}\label{eqn:gainInitial}
	d_{i,k+1} = d_{i,k} + g_{i,k,l},
\end{align}
where the $l^{\text{th}}$ charge edge is active. 
\par $g_{i,k,l}$ is computed using the Constant Current Constant Voltage (CCCV) model as derived in \cite{whitaker_network_2021} which gives:
\begin{align}\label{eqn:CCCV}
	d_{i,k+1} = \bar{a}_ld_{i,k} - \bar{b}_lM 
\end{align}
Where $\bar{a}_l$ $\sim(0,1]$, depends on the charge rate and is experimentally determined, $M$ is the battery charge capacity in kWh, and $\bar{b}_l = \bar{a}_l - 1$.
Equations \ref{eqn:gainInitial} and \ref{eqn:CCCV} are used to show that
\begin{equation}\label{eqn:g}
\begin{aligned}
	& d_{i,k+1} = \bar{a}_ld_{i,k} - \bar{b}_lM \\ 
	\Rightarrow & d_{i,k+1} - d_{i,k} = \bar{a}_ld_{i,k} - \bar{b}_lM - d_{i,k}\\
	\Rightarrow & g_{i,k,l}  = \bar{a}_ld_{i,k} - \bar{b}_lM - d_{i,k}\\
	\Rightarrow & g_{i,k,l}  = (\bar{a}_l - 1)d_{i,k} - \bar{b_l}M\\
\end{aligned}
\end{equation}

The results from equation \ref{eqn:g}, however, only hold when a charger is connected to a bus, which is represented by a weight of $1$ for the edge corresponding to $g_{i,k,l}$. When the weight equals $0$, $g_{i,k,l}$ must also equal zero. These two situations can be described using a switching constraint known as the \textit{big M} technique. This technique is used to describe $g_{i,k,l}$ with equation \ref{eqn:g} when the transition weight is $1$ and $g_{i,k,l} = 0$ when $0$.
\begin{equation}\label{eqn:bigMIneq}
\begin{aligned}
	& \begin{dcases} 
		\begin{array}{l}
		g_{i,k,l} = d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM
		\end{array} & x_{i,k,l} = 1\\
		\begin{array}{l}
		g_{i,k,l} = 0
		\end{array} & x_{i,k,l} = 0\\
	\end{dcases} \\ 
	\Rightarrow & 
	\begin{dcases} 
		\begin{array}{l}
		g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		\end{array}
		& x_{i,k,l} = 1 \\
		\begin{array}{l}
		g_{i,k,l} \le 0 \\
		g_{i,k,l} \ge 0 \\
		\end{array} & x_{i,k,l} = 0\\
    	\end{dcases} 
\end{aligned}
\end{equation}
where $x_{i,k,l}$ is the edge weight corresponding to $g_{i,k,l}$.  The piecewise function in equation \ref{eqn:bigMIneq} can be rewritten as 
\begin{equation}\label{eqn:bigM2}
 \begin{aligned} 
	 &\begin{dcases} 
		\begin{array}{l}
		g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM\\
		\end{array}
		& x_{i,k,l} = 1 \\
		\begin{array}{l}
		g_{i,k,l} \le 0 \\
		g_{i,k,l} \ge 0 \\
		\end{array} & x_{i,k,l} = 0\\ 
	\end{dcases} \\
	\Rightarrow & 
	 \begin{array}{l}
		 g_{i,k,l} \le d_{i,k}(\bar{a}_l - 1) - \bar{b}M - M(1 - x_{i,k,l})\\
		 g_{i,k,l} \ge d_{i,k}(\bar{a}_l - 1) - \bar{b}M\\
		 g_{i,k,l} \le 0 + Mx_{i,k,l} \\
		 g_{i,k,l} \ge 0 \\
	 \end{array}
\end{aligned}
\end{equation}
The results of equation \ref{eqn:bigM2} obtain a switching effect.  When $x_{i,k,l} = 1$, equation \ref{eqn:bigM2} becomes 
\begin{equation}
	\begin{aligned}
		\color{blue}{g_{i,k,l}}  &\color{blue}{\le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM} \\
		\color{blue}{g_{i,k,l}}  &\color{blue}{\ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM} \\
		\color{red}{g_{i,k,l}} & \color{red}{\le M} \\
		\color{red}{g_{i,k,l}} & \color{red}{\ge 0}.  
	\end{aligned}
\end{equation}
The \textcolor{blue}{active constraints} imply equality for $g_{i,k,l}$ = $(\bar{a}_l - 1)d_{i,k} - \bar{b_l}M$.  The \textcolor{red}{inactive constraints} imply that $g_{i,k,l}$ is greater then zero, and less then the battery capacity.  These constraints are also true, but have no effect on $g_{i,k,l}$. When $x_{i,k,l} = 0$, equation \ref{eqn:bigM2} becomes
\begin{equation}
	\begin{aligned}
		\color{red}{g_{i,k,l}}  &\color{red}{\le d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM - M} \\
		\color{red}{g_{i,k,l}}  &\color{red}{\ge d_{i,k}(\bar{a}_l - 1) - \bar{b}_lM} \\
		\color{blue}{g_{i,k,l}} &\color{blue}{\le 0} \\
		\color{blue}{g_{i,k,l}} &\color{blue}{\ge 0}.  
	\end{aligned}
\end{equation}
Where the \textcolor{red}{inactive constraints} indicate that $g_{i,k,l}$ is less then some positive value, and greater than a negative value. These constarints have no effect as the \textcolor{blue}{active constraints} imply equality for $g_{i,k,l} = 0$.

\par Equation \ref{eqn:bigM2} can be expressed in linear form as 
\begin{equation}\label{eqn:chargeConstraints}
	\begin{aligned} 
		-g_{i,k,l} + d_{i,k}(\bar{a}_l - 1) + x_{i,k,l} &\le M(\bar{b_l} + 1) \\
		 g_{i,k,l} - d_{i,k}(\bar{a}_l - 1)  &\le  - \bar{b_l}M \\
		 g_{i,k,l} - Mx_{i,k} &\le 0 \\
		-g_{i,k,l} &\le 0.  
	\end{aligned}
\end{equation} 
